## 要件定義書

**案件名**：Stable Diffusionメタデータ抽出ツール（Windowsローカル版）  
**作成日**：2025-06-29  
**作成者**：ChatGPT（案）

---

### 1. 目的

ローカルフォルダ内（上限1,000枚程度）の _.png_ 画像について、各ファイルに埋め込まれた Stable Diffusion の **ポジティブプロンプト**（以下「プロンプト」）を一括抽出し、次の形式でテキストファイルに出力できる Windows 向けツールを開発する。

```
<画像ファイル名>のprompt

<次の画像ファイル名>のprompt

…
```

---

### 2. 背景・課題

- 画像のプロンプトを再利用・検索したい。
    
- 既存のビューワやタグ管理ソフトは SD の長いプロンプト全文を一覧取得する用途に向かない。
    
- オフライン環境でも動く単機能のローカルツールを要望。
    

---

### 3. 用語定義

|用語|定義|
|---|---|
|**プロンプト**|Stable Diffusion の _PNGTextChunk_／EXIF _Parameters_ フィールドに格納される `Positive prompt:` 以降の文字列|
|**対象フォルダ**|ユーザが指定する、画像を格納したローカルディレクトリ（サブフォルダは検索対象外）|

---

### 4. スコープ

|項目|スコープ|
|---|---|
|対応 OS|Windows 10 / 11 (64-bit) 日本語版|
|対応画像|拡張子 _.png_ ／ファイルサイズ最大 100 MB|
|最大件数|1,000 枚／回（将来拡張を見込むが性能保証は 1,000 枚まで）|
|出力形式|UTF-8 テキストファイル（_.txt_）1 ファイル|
|UI|① コマンドライン ②（将来）最小限 GUI オプション|

---

### 5. 機能要件

|番号|区分|要件|
|---|---|---|
|F-1|入力|起動パラメータで対象フォルダを指定できる。未指定時は起動ディレクトリを使用。|
|F-2|抽出|各 _.png_ から「Positive prompt:」〜改行直前までを抽出する。 - キー名は `parameters`, `Prompt`, `Description` を優先順で検索。 - 当該キーが複数存在する場合は最初に一致したものを採用。|
|F-3|出力|以下のフォーマットで 1 ファイルに追記して保存。`<ファイル名>.pngのprompt` + 改行 + 改行（空行）|
|F-4|デフォルト出力先|対象フォルダ直下に `prompts_<YYYYMMDD_HHMMSS>.txt` を生成。|
|F-5|エラーログ|抽出できなかったファイル名と理由を `error.log` に出力（例：プロンプト欠如・破損）。|
|F-6|処理完了通知|件数・処理時間・エラー件数をコンソールに表示。|
|F-7|文字コード|入出力とも UTF-8 (BOM なし)。|

---

### 6. 非機能要件

|区分|要件|
|---|---|
|パフォーマンス|1,000 枚を 30 秒以内（実測 Core i5/8 GB RAM/SSD）で処理。マルチスレッド処理を推奨。|
|信頼性|抽出処理が途中で失敗しても既に書き込んだ行は保持。エラー後も残りを継続処理。|
|セキュリティ|外部通信なし・ログイン不要。処理対象と出力はすべてローカルに限定。|
|可用性|実行ファイルと依存 DLL／ランタイムのみで動作（インストーラ不要のポータブル構成推奨）。|
|保守性|ソースを Git 管理し MIT License で公開予定。モジュール分離（CLI／抽出ロジック／出力ロジック）。|
|ユーザビリティ|`drag & drop` でバッチファイル起動できるサンプル同梱。GUI （WPF or WinUI）版を後日追加できる設計。|
|国際化|日本語 UI/ログのみ（英語表示は非対応）。|

---

### 7. 運用・導入要件

1. **前提ソフト**
    
    - Python 3.12（推奨） + `piexif`, `pillow`, `tqdm` など OSS ライブラリ
        
    - もしくは PyInstaller で単一 EXE をビルドし配布。
        
2. **導入手順**
    
    - ZIP 展開 → `extract_prompts.exe <対象フォルダ>` で実行。
        
    - 社内端末に管理者権限不要。
        
3. **バックアップ**
    
    - 出力 TXT は抽出後 Git/OneDrive 等でバージョン管理推奨。
        

---

### 8. 受入基準

|テスト項目|合格基準|
|---|---|
|正常系|サンプル 100 枚で全件抽出成功・フォーマット一致。|
|負荷試験|1,000 枚・総容量 2 GB を 30 秒以内で完了。|
|異常系|プロンプト欠如ファイルをスキップし `error.log` に記録。プログラムが異常終了しない。|
|ローカライズ|すべてのメッセージが日本語で表示される。|

---

### 9. 制約・留意事項

- **PNG 以外（JPG／WEBP 等）は対象外**：要件外エラーとしてスキップ。
    
- **暗号化・壊れたファイル**：抽出不可扱い。
    
- **ネガティブプロンプト**・モデル設定などの追加キーは **本バージョンでは非対応**。
    
---

### 10. 今後の拡張候補（参考）

1. **ネガティブプロンプト・シード値** の同時抽出。
    
2. **サブフォルダ再帰検索**・フィルタ（例：`--tag "portrait"`）。
    
3. **GUI 版**：画像プレビュー＋コピー機能。
    
4. **検索・重複検出 DB**：SQLite 連携しプロンプト全文検索。
    

---

以上